# Cantotype

Chinese and Cantonese typing app with phonetic and dictionary support, implemented as a 100% client-side JavaScript webapp.

## Building the data files

Cantotype loads all its character and dictionary data from a set of compressed data files.  You can generate these files with the `canto_compile.pl` Perl script.  This Perl script reads from provided Unihan, HKSCS supplement, and CC-CEDICT sources to build the data files containing all the necessary data.  See the documentation of that script for further information.

All of the data files generated by this script will need to be placed in the same directory on the server.  This directory does not need to be the same directory as the directory containing the other parts of the webapp.

The directory of data files can be shared amongst multiple Cantotype deployments.

## Generating the configuration file

You also must generate a JavaScript configuration file that tells Cantotype about the specific installation and allows it to locate its data and library files.  You can generate this script with the `canto_config.pl` Perl script.  Store the results of this script in a file named `cantotype_config.js` in the same directory as the main HTML page of the webapp.  As part of this configuration process, you will tell the configuration script where the webapp can find the Cantotype data files generated in the last step.  See the documentation of the `canto_config.pl` script for further information.

## Preparing the fonts

Since it is not safe to assume support of the Chinese character set, Cantotype uses its own webfonts to ensure that all clients can display the Chinese characters.  All the fonts used by Cantotype are free, but they are not provided directly here.  You need the following font files:

- `freehk.woff` - Free-HK webfont
- `notosanshk.woff` - Noto Sans HK webfont
- `lastresort.woff` - Last Resort webfont

The [Free-HK project](https://freehkfonts.opensource.hk/) provides the Free-HK webfont on the download page of its website, and you can also get it from the [Github page](https://github.com/freehkfonts/freehkkai) (currently, the actual font file is on the "download" branch).  This font is licensed under CC-BY 4.0.

Noto Sans HK is provided by [Google Fonts](https://github.com/googlefonts/noto-cjk) in their `noto-cjk` project on Github.  You can also get this font from the public [Google Fonts](https://fonts.google.com/) page on Google.  This font is licensed under SIL Open Font License 1.1.  Within the `noto-cjk` project, the recommended font is `Sans/SubsetOTF/HK/NotoSansHK-Regular.otf`

Last Resort is provided by the Unicode Consortium at their [Github page](https://github.com/unicode-org/last-resort-font).  You can download the actual font file from the latest release.  This font is licensed under SIL Open Font License 1.1.

After you download the font files, you will need to convert them to the webfont WOFF format.  You can use the program `sfnt2woff` [provided here](https://github.com/kseo/sfnt2woff) to convert each of these fonts to WOFF.

The final step is to rename the WOFF fonts exactly with the names given earlier in this section.  The fonts should then be placed in the same server directory as the main HTML file so they can be loaded by its CSS stylesheet.

The three fonts form a cascade.  Free-HK is the preferred font, but it only contains 4,700 of the most common Chinese characters.  Characters that are not present in Free-HK will be displayed with Noto Sans HK, which includes less common characters, as well as characters specific to Cantonese.  Characters that are not present in Noto Sans HK either will be displayed with Last Resort, which just provides a placeholder image for missing characters.

This allows you to determine how common a character is by the way it is rendered.  Free-HK is a regular script font, which indicates the character is common.  Noto Sans HK is a straight sans-serif font, which indicates the character is less common or specific to Cantonese.  Last Resort has distinctive boxes indicating the character is missing, so you can tell that the character is not widely supported.

## Fetching the libraries

In order to speed up download of the rather large data files, the data files are compressed with GZip and decompressed client-side.  The [Pako](https://github.com/nodeca/pako) library is used to decompress these GZipped files on the client side.  From the `dist` directory of the Pako project, you will need the `pako_inflate.js` script and place this in the same directory as the main Cantotype HTML page.  You can also use `pako_inflate.min.js` provided that you rename it to `pako_inflate.js`.

Initial versions of Cantotype used in-memory JavaScript structures to store the database, but the large size of the database was causing issues on some clients.  For more reliable operation, Cantotype uses [sql.js](https://github.com/sql-js/sql.js) which is a Webassembly compilation of SQLite that is run client-side.  You can get the actual loading script and Webassembly module from the release.  Specifically, you will need `sql-wasm.js` which is the loading script, and `sql-wasm.wasm` which is the Webassembly compilation of SQLite.

## Using a server

Although Cantotype is completely client-side and does not use any server-side scripting, some of the client-side technologies it uses are not reliable unless they are used over HTTP.  This means that it is __not__ recommended to run Cantotype directly in the file system using the `file://` protocol.

You can either place Cantotype on an Internet server, or you can use the simple [Jacques](https://github.com/canidlogic/jacques) HTTP server script to serve Cantotype locally over HTTP.  Jacques has been used during the development of Cantotype, so it is officially supported and should work without issue.

## Assembling the files

All in the same directory on the HTTP server, you need the following files:

- `cantotype.html` - the main webapp HTML page
- `cantotype.js` - the main program module
- `cantotype_load.js` - the data loading module
- `cantotype_config.js` - the generated configuration script
- `pako_inflate.js` - the Pako GZip decompressor
- `sql-wasm.js` - the sql.js loader
- `sql-wasm.wasm` - the sql.js Webassembly module
- `freehk.woff` - the Free-HK webfont
- `notosanshk.woff` - the Noto Sans HK webfont
- `lastresort.woff` - the Last Resort webfont

All of these files must have the exact same names listed above (case sensitive), except that the main `cantotype.html` page can be renamed anything you want, including using it as the index page for the server directory.

You must also place all the Cantotype data files either in this directory or in another directory on the HTTP server.  The specific directory they are placed in and the name of the data index file within the directory must match the configuration parameters within the generated `cantotype_config.js` file.

Finally, make sure that the SQL loading URL prefix in the `cantotype_config.js` file matches the server directory containing the sql.js files.

You may want to verify that the HTTP server understands the file extensions of all the files listed earlier in this section, as well as the file extension used for the generated data files.  Here is a list of MIME content types for each of the extensions, which is useful if you are creating a JSON website file for use with the Jacques HTTP server:

     Extension |    MIME type
    ===========+==================
       .html   | text/html
       .js     | text/javascript
       .wasm   | application/wasm
       .woff   | font/woff

For the data files, if they have the extension `.gz` you can either give them the MIME type `application/gzip` or the MIME type `application/octet-stream`

__Important:__ The data files served to the client must arrive at the client still in GZip compressed form.  The client-side JavaScript will decompress them.  Do __not__ allow the HTTP server to transfer them with a `Content-Encoding` header indicating `gzip` compression, because in this case the client browser will decompress the files before passing them to JavaScript, which will then try to decompress them again.  Make sure they reach the JavaScript code still in a compressed state.

Provided that all the files are generated and assembled as described in this README, you just need to navigate to wherever you placed the main Cantotype HTML page and the webapp should start.  Since no server-side scripting is required, you may run Cantotype even if your HTTP server only allows static websites.
